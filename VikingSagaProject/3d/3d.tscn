[gd_scene load_steps=23 format=3]

[ext_resource path="res://materials/Wood.tres" type="StandardMaterial3D" id=1]
[ext_resource path="res://materials/Concrete.tres" type="StandardMaterial3D" id=2]
[ext_resource path="res://scripts/PlayerController.gd" type="Script" id=3]
[ext_resource path="res://audio/wind.ogg" type="AudioStream" id=4]
[ext_resource path="res://audio/door_creak.ogg" type="AudioStream" id=5]

[sub_resource type="Environment" id=1]
background_mode = 2  # Use Sky
sky = SubResource(2)
ambient_light_color = Color(0.45, 0.45, 0.5, 1)  # subtle ambient light
ambient_light_energy = 0.3
fog_enabled = false
fog_color = Color(0.5, 0.6, 0.7, 1)
fog_depth_enabled = true
fog_depth_begin = 30.0
fog_depth_end = 100.0
ssao_enabled = true
ssao_radius = 2.0
ssao_intensity = 1.0
ssao_quality = 1  # medium quality SSAO
glow_enabled = true
glow_bloom = 0.1
glow_intensity = 0.8
glow_threshold = 1.0
tonemap_mode = 1  # ACES tonemapping
auto_exposure_enabled = false
tonemap_exposure = 1.0

[sub_resource type="Sky" id=2]
sky_material = SubResource(3)

[sub_resource type="ProceduralSkyMaterial" id=3]
sky_energy = 1.0
ground_color = Color(0.1, 0.1, 0.1, 1)
horizon_color = Color(0.4, 0.5, 0.7, 1)
zenith_color = Color(0.1, 0.4, 0.8, 1)
sun_angle = Vector2(45.0, 0.0)  # sun at 45 deg elevation
sun_angular_size = 4.0
sun_energy = 1.0

[sub_resource type="CubeMesh" id=4]
size = Vector3(1.0, 2.0, 0.1)  # Door panel mesh (1m x 2m x 0.1m)

[sub_resource type="PlaneMesh" id=5]
size = Vector2(20.0, 20.0)  # Floor mesh 20x20

[sub_resource type="BoxShape3D" id=6]
# Floor collision shape (half extents 10x0.1x10 to cover 20x0.2x20 area)
size = Vector3(10.0, 0.1, 10.0)

[sub_resource type="CubeMesh" id=7]
size = Vector3(20.0, 5.0, 0.5)  # Wall mesh 20m x 5m x 0.5m

[sub_resource type="BoxShape3D" id=8]
# Wall collision shape (half extents 10x2.5x0.25 for 20x5x0.5 wall)
size = Vector3(10.0, 2.5, 0.25)

[sub_resource type="CubeMesh" id=9]
size = Vector3(1.0, 1.0, 1.0)  # Cube mesh for crates or small objects

[sub_resource type="CylinderMesh" id=10]
top_radius = 0.5
bottom_radius = 0.5
height = 3.0
radial_segments = 12  # Tree trunk mesh

[sub_resource type="SphereMesh" id=11]
radius = 2.0
height = 1.0
radial_segments = 16  # Tree foliage mesh (sphere)

[sub_resource type="CapsuleShape3D" id=12]
radius = 0.5
height = 1.7  # Player collision capsule

[sub_resource type="ArrayOccluder3D" id=13]
# Occluder shape covering a wall (rectangle vertices)
vertices = PackedVector3Array( 10, 2.5, 0,   10, -2.5, 0,   -10, -2.5, 0,   -10, 2.5, 0 )
# (This represents a quad 20m x 5m in the occluder's local XY plane)

[sub_resource type="Animation" id=14]
resource_name = "DoorOpen"
length = 1.0
tracks/0/type = "value"
tracks/0/path = NodePath("../DoorMesh:rotation_degrees")
tracks/0/interp = 1
tracks/0/keys = {
    "times": PackedFloat32Array(0.0, 1.0),
    "transitions": PackedFloat32Array(1.0, 1.0),
    "update": 0,
    "values": [ Vector3(0, 0, 0), Vector3(0, -90, 0) ]
}

[sub_resource type="Animation" id=15]
resource_name = "DoorClose"
length = 1.0
tracks/0/type = "value"
tracks/0/path = NodePath("../DoorMesh:rotation_degrees")
tracks/0/interp = 1
tracks/0/keys = {
    "times": PackedFloat32Array(0.0, 1.0),
    "transitions": PackedFloat32Array(1.0, 1.0),
    "update": 0,
    "values": [ Vector3(0, -90, 0), Vector3(0, 0, 0) ]
}

[sub_resource type="BoxShape3D" id=16]
# Crate collision shape (half extents 0.5x0.5x0.5 for 1x1x1 crate)
size = Vector3(0.5, 0.5, 0.5)

[sub_resource type="ParticlesMaterial" id=17]
emission_shape = 2  # EMISSION_SHAPE_BOX
emission_box_extents = Vector3(25.0, 1.0, 25.0)  # Rain spread over area
gravity = Vector3(0, -9.8, 0)
initial_velocity = 25.0
lifetime = 1.5
one_shot = false
preprocess = 0.0

[node name="Main" type="Node3D"]
# Environment group: sky, lighting, global effects
[node name="Environment" type="Node3D" parent="."]
    [node name="WorldEnvironment" type="WorldEnvironment" parent="Environment"]
    environment = SubResource(1)
    [node name="DirectionalLight" type="DirectionalLight3D" parent="Environment"]
    rotation_degrees = Vector3(50, 30, 0)  # angled sunlight
    light_energy = 6.0
    shadow_enabled = true
    shadow_bias = 0.02
    shadow_normal_bias = 2.0
    shadow_blend_splits = true
    # Using soft shadows (PCF13) via project settings for smoother shadows
    [node name="ReflectionProbe" type="ReflectionProbe3D" parent="Environment"]
    transform = Transform3D( 10,0,0,  0,10,0,  0,0,10,  0,2.5,0 )
    cull_mask = 1  # affect all visible layers
    box_size = Vector3(30, 10, 30)
    box_projection = true
    update_mode = 0  # UPDATE_ONCE at start
    [node name="OccluderWall" type="OccluderInstance3D" parent="Environment"]
    transform = Transform3D( 1,0,0,  0,1,0,  0,0,1,  0,2.5,-10 )
    occluder = SubResource(13)
    [node name="AmbientSound" type="AudioStreamPlayer" parent="Environment"]
    stream = ExtResource(4)
    autoplay = true
    volume_db = -5.0
    # Rain particles (off by default, can be toggled for weather effect)
    [node name="Rain" type="GPUParticles3D" parent="Environment"]
    process_material = SubResource(17)
    emitting = false
    amount = 1000

# Static geometry: floor, walls, props (grouped under Static)
[node name="Static" type="Node3D" parent="."]
    [node name="Floor" type="StaticBody3D" parent="Static"]
    transform = Transform3D( 1,0,0,  0,1,0,  0,0,1,  0,0,0 )
        [node name="Mesh" type="MeshInstance3D" parent="Floor"]
        mesh = SubResource(5)
        material_override = ExtResource(2)  # concrete material
        [node name="Collision" type="CollisionShape3D" parent="Floor"]
        shape = SubResource(6)
    [node name="WallNorth" type="StaticBody3D" parent="Static"]
    transform = Transform3D( 1,0,0,  0,1,0,  0,0,1,  0,0,-10 )
        [node name="Mesh" type="MeshInstance3D" parent="WallNorth"]
        mesh = SubResource(7)
        material_override = ExtResource(2)
        [node name="Collision" type="CollisionShape3D" parent="WallNorth"]
        shape = SubResource(8)
    [node name="WallSouth" type="StaticBody3D" parent="Static"]
    transform = Transform3D( -1,0,0,  0,1,0,  0,0,-1,  0,0,10 )
        [node name="Mesh" type="MeshInstance3D" parent="WallSouth"]
        mesh = SubResource(7)
        material_override = ExtResource(2)
        [node name="Collision" type="CollisionShape3D" parent="WallSouth"]
        shape = SubResource(8)
    [node name="WallEast" type="StaticBody3D" parent="Static"]
    transform = Transform3D( 0,0,1,  0,1,0,  -1,0,0,  10,0,0 )
        [node name="Mesh" type="MeshInstance3D" parent="WallEast"]
        mesh = SubResource(7)
        material_override = ExtResource(2)
        [node name="Collision" type="CollisionShape3D" parent="WallEast"]
        shape = SubResource(8)
    [node name="WallWest" type="StaticBody3D" parent="Static"]
    transform = Transform3D( 0,0,-1,  0,1,0,  1,0,0,  -10,0,0 )
        [node name="Mesh" type="MeshInstance3D" parent="WallWest"]
        mesh = SubResource(7)
        material_override = ExtResource(2)
        [node name="Collision" type="CollisionShape3D" parent="WallWest"]
        shape = SubResource(8)
    [node name="TreeLOD" type="LOD" parent="Static"]
    translation = Vector3(5, 0, 5)
        [node name="TreeHigh" type="Node3D" parent="TreeLOD"]
        lod_range = 30.0
            [node name="Trunk" type="MeshInstance3D" parent="TreeHigh"]
            mesh = SubResource(10)
            material_override = ExtResource(1)  # reuse wood material for trunk
            [node name="Leaves" type="MeshInstance3D" parent="TreeHigh"]
            mesh = SubResource(11)
            material_override = ExtResource(1)  # (Using wood material as placeholder for leaves)
        [node name="TreeLow" type="MeshInstance3D" parent="TreeLOD"]
        lod_range = 60.0
        mesh = SubResource(11)
        material_override = ExtResource(1)
        scale = Vector3(0.5, 0.5, 0.5)  # smaller sphere as distant tree
    [node name="Crate1" type="StaticBody3D" parent="Static"]
    translation = Vector3(3, 0.5, 3)
        [node name="Mesh" type="MeshInstance3D" parent="Crate1"]
        mesh = SubResource(9)
        material_override = ExtResource(1)  # wood material
        [node name="Collision" type="CollisionShape3D" parent="Crate1"]
        shape = SubResource(16)
    [node name="Crate2" type="StaticBody3D" parent="Static"]
    translation = Vector3(5, 0.5, 2)
        [node name="Mesh" type="MeshInstance3D" parent="Crate2"]
        mesh = SubResource(9)
        material_override = ExtResource(1)
        [node name="Collision" type="CollisionShape3D" parent="Crate2"]
        shape = SubResource(16)

# Interactive elements: door, switch, lamp
[node name="Interactive" type="Node3D" parent="."]
    [node name="Door" type="StaticBody3D" parent="Interactive"]
    translation = Vector3(-5, 0, -9.75)
        [node name="DoorMesh" type="MeshInstance3D" parent="Door"]
        mesh = SubResource(4)
        material_override = ExtResource(1)
        [node name="DoorCollision" type="CollisionShape3D" parent="Door"]
        shape = BoxShape3D { size = Vector3(0.5, 1.0, 0.05) }  # thin box collider for door
        [node name="DoorSound" type="AudioStreamPlayer3D" parent="Door"]
        stream = ExtResource(5)
        autoplay = false
        [node name="DoorAnimator" type="AnimationPlayer" parent="Door"]
        animations/open = SubResource(14)
        animations/close = SubResource(15)
    [node name="LightSwitch" type="Area3D" parent="Interactive"]
    translation = Vector3(-7, 1.5, -9)
        [node name="SwitchMesh" type="MeshInstance3D" parent="LightSwitch"]
        mesh = SubResource(9)
        material_override = ExtResource(2)
        scale = Vector3(0.2, 0.2, 0.1)  # small switch panel
        [node name="SwitchCollision" type="CollisionShape3D" parent="LightSwitch"]
        shape = BoxShape3D { size = Vector3(0.1, 0.1, 0.05) }
        [node name="SwitchAudio" type="AudioStreamPlayer3D" parent="LightSwitch"]
        stream = ExtResource(5)  # (Placeholder: could be a switch click sound)
        autoplay = false
        # (Script on LightSwitch (not shown) would handle body_entered and toggle LampLight)
    [node name="LampLight" type="OmniLight3D" parent="Interactive"]
    translation = Vector3(0, 4.5, 0)
    omni_range = 20.0
    light_energy = 500.0
    shadow_enabled = false
    visible = true

# Player character with camera
[node name="Player" type="CharacterBody3D" parent="."]
translation = Vector3(0, 1, 0)
rotation_degrees = Vector3(0, 180, 0)
camera_orientation = Vector3(0, 0, 0)
script = ExtResource(3)
    [node name="CollisionShape" type="CollisionShape3D" parent="Player"]
    shape = SubResource(12)
    [node name="Camera3D" type="Camera3D" parent="Player"]
    translation = Vector3(0, 1.6, 0)  # camera at ~eyes height
    current = true

# UI layer for on-screen hints or HUD
[node name="UI" type="CanvasLayer" parent="."]
    [node name="HintLabel" type="Label" parent="UI"]
    text = "Press [E] to interact"
    visible = false
    anchor_right = 1.0
    anchor_bottom = 1.0
    margin_right = 0.0
    margin_bottom = -20.0  # 20px from bottom
    horizontal_alignment = 1  # center
    [node name="UIAnimation" type="AnimationPlayer" parent="UI"]
    # (Animation tracks for fading HintLabel in/out could be added here)

